## TODO
#  hostname (slurm-hpc-slurm-io-login0) and username should be variables

steps:
  ## Step -1: Provision cluster
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: /bin/bash
    args:
    - '-c'
    - |
      set -e
      apt-get update && apt-get install -y keychain dnsutils
      ssh-keygen -t rsa -N '' -f id_rsa
      DIP=$(dig TXT +short o-o.myaddr.l.google.com @ns1.google.com | awk -F'"' '{print $2}')
      echo "DIG IP Address: $$DIP"
      echo $$DIP >> my_ip.txt
      echo "Creating a firewall rule 'build-$BUILD_ID' allowing SSH from '$$DIP'"
      gcloud compute --project=$PROJECT_ID firewall-rules create \
        "build-$BUILD_ID"   \
        --direction=INGRESS --priority=1000 --network=default --action=ALLOW \
        --rules=tcp:22 --source-ranges=$$(cat my_ip.txt)
  - name: gcr.io/cloud-builders/gcloud
    args:
    - compute
    - os-login
    - ssh-keys
    - add
    - --ttl
    - 2h
    - '--key-file=./id_rsa.pub'
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: /bin/bash
    args:
    - -c
    - |
      gcloud compute instances describe --zone=us-central1-a \
      slurm-hpc-slurm-io-login0 \
      --format='get(networkInterfaces[0].accessConfigs[0].natIP)' > login_ip.txt
  # - name: gcr.io/cloud-builders/gcloud
  #   entrypoint: /bin/bash
  #   args:
  #   - -c
  #   - |
  #     gcloud iam service-accounts describe \
  #       cloud-build-integration-tester@hpc-toolkit-dev.iam.gserviceaccount.com \
  #       --format='value(uniqueId)' > sa_username.txt
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: /bin/bash
    args:
    - '-c'
    - |
      ssh -i id_rsa -o StrictHostKeychecking=no \
        sa_106486320838376751393@$(cat login_ip.txt) hostname
  - name: us-central1-docker.pkg.dev/$PROJECT_ID/hpc-toolkit-repo/ansible:latest
    entrypoint: /bin/sh
    env:
    - "ANSIBLE_HOST_KEY_CHECKING=false"
    args:
    - -c
    - |
      ansible-playbook --user=sa_106486320838376751393 --inventory=login_ip.txt \
        --private-key=./id_rsa daily-tests/high-io-tests.yaml
  - name: gcr.io/cloud-builders/gcloud
    args:
    - compute
    - firewall-rules
    - delete
    - "build-$BUILD_ID"

# logsBucket: 'gs://hpc-toolkit-daily-tests-logs'
# serviceAccount: 'projects/hcp-toolkit-dev/serviceAccounts/cloud-build-integration-tester@hpc-toolkit-dev.iam.gserviceaccount.com'

# options:
#   logging: GCS_ONLY
